version: "3.8"

services:
  # ============================================
  # üöÄ Next.js Application
  # ============================================
  # - Build ‡∏à‡∏≤‡∏Å Dockerfile ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  # - ‡πÄ‡∏õ‡∏¥‡∏î port 3000 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡πá‡∏ö
  # - ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå upload ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô host machine
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: report-request-app
    restart: always
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=production
      # ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô DATABASE_URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö app_db
      - DATABASE_URL=mysql://user:password@app_db:3306/reporting_db
      # External Database (HOSxP) - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö verify user
      - EXTERNAL_DB_HOST=your-hosxp-db-host
      - EXTERNAL_DB_PORT=3306
      - EXTERNAL_DB_USER=hosxp_user
      - EXTERNAL_DB_PASSWORD=hosxp_password
      - EXTERNAL_DB_NAME=hosxp
      # ‚ö†Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢: openssl rand -base64 32
      - AUTH_SECRET=change-this-with-openssl-rand
      - NEXTAUTH_URL=https://your-domain.com
      # Email SMTP
      - SMTP_HOST=smtp.example.com
      - SMTP_PORT=587
      - SMTP_USER=noreply@example.com
      - SMTP_PASSWORD=smtp_password
      - SMTP_FROM=noreply@example.com
      # ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô default admin credentials
      - ADMIN_USERNAME=appadmin
      - ADMIN_PASSWORD=Admin@11241
    volumes:
      # üìÅ Bind Mount: ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå upload ‡∏ö‡∏ô host
      # Host: ./data/uploads ‚Üí Container: /app/public/uploads
      - ./data/uploads:/app/public/uploads
    depends_on:
      - app_db
    networks:
      - app_network

  # ============================================
  # üóÑÔ∏è MySQL Database
  # ============================================
  # - ‡πÉ‡∏ä‡πâ MySQL 8.0 official image
  # - ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô host machine (‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠ restart/drop)
  # - ‡πÄ‡∏õ‡∏¥‡∏î port 3307 (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ä‡∏ô‡∏Å‡∏±‡∏ö MySQL ‡∏ö‡∏ô host)
  app_db:
    image: mysql:8.0
    container_name: report-request-db
    restart: always
    environment:
      # ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password ‡∏Å‡πà‡∏≠‡∏ô deploy ‡∏à‡∏£‡∏¥‡∏á!
      MYSQL_ROOT_PASSWORD: root_password_change_me
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: reporting_db
    ports:
      - "3307:3306"
    volumes:
      # üìÅ Bind Mount: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• DB ‡∏ö‡∏ô host
      # Host: ./data/mysql ‚Üí Container: /var/lib/mysql
      - ./data/mysql:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - app_network

networks:
  app_network:
    driver: bridge

# ============================================
# üìù ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
# ============================================
#
# 1. services.app (Next.js Application)
#    - build: ‡∏™‡∏£‡πâ‡∏≤‡∏á image ‡∏à‡∏≤‡∏Å Dockerfile
#    - restart: always = ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ crash
#    - ports: ‡πÄ‡∏õ‡∏¥‡∏î 3001 ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
#    - volumes: ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå upload ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô host (./data/uploads)
#
# 2. services.app_db (MySQL Database)
#    - image: mysql:8.0 = ‡πÉ‡∏ä‡πâ official MySQL image
#    - volumes: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• DB ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô host (./data/mysql)
#    - command: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ charset ‡πÄ‡∏õ‡πá‡∏ô utf8mb4 ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
#
# 3. Data Persistence (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢!)
#    - ‡πÉ‡∏ä‡πâ Bind Mount ‡πÅ‡∏ó‡∏ô Named Volume
#    - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ./data/ ‡∏ö‡∏ô host
#    - ‡πÄ‡∏°‡∏∑‡πà‡∏≠ docker-compose down ‡∏´‡∏£‡∏∑‡∏≠ restart ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
#
# 4. ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:
#    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô
#    mkdir -p ./data/uploads ./data/mysql
#
#    # ‡∏£‡∏±‡∏ô
#    docker compose -f docker-compose.prod.yml up -d --build
#
#    # ‡∏´‡∏¢‡∏∏‡∏î (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)
#    docker compose -f docker-compose.prod.yml down
#
#    # ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö volume (‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢!)
#    docker compose -f docker-compose.prod.yml down -v
